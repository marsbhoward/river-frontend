{"ast":null,"code":"'use strict';\n\nvar path = require('path'),\n    util = require('util'),\n    EventEmitter = require('events').EventEmitter,\n    request = require('request'),\n    _ = require('lodash'),\n    cheerio = require('cheerio'),\n    fs = require('fs'),\n    Bottleneck = require('bottleneckp'),\n    seenreq = require('seenreq'),\n    iconvLite = require('iconv-lite'),\n    typeis = require('type-is').is;\n\nvar whacko = null,\n    level,\n    levels = ['silly', 'debug', 'verbose', 'info', 'warn', 'error', 'critical'];\n\ntry {\n  whacko = require('whacko');\n} catch (e) {\n  e.code;\n}\n\nfunction defaultLog() {\n  //2016-11-24T12:22:55.639Z - debug:\n  if (levels.indexOf(arguments[0]) >= levels.indexOf(level)) console.log(new Date().toJSON() + ' - ' + arguments[0] + ': CRAWLER %s', util.format.apply(util, Array.prototype.slice.call(arguments, 1)));\n}\n\nfunction checkJQueryNaming(options) {\n  if ('jquery' in options) {\n    options.jQuery = options.jquery;\n    delete options.jquery;\n  }\n\n  return options;\n}\n\nfunction readJqueryUrl(url, callback) {\n  if (url.match(/^(file:\\/\\/|\\w+:|\\/)/)) {\n    fs.readFile(url.replace(/^file:\\/\\//, ''), 'utf-8', function (err, jq) {\n      callback(err, jq);\n    });\n  } else {\n    callback(null, url);\n  }\n}\n\nfunction contentType(res) {\n  return get(res, 'content-type').split(';').filter(item => item.trim().length !== 0).join(';');\n}\n\nfunction get(res, field) {\n  return res.headers[field.toLowerCase()] || '';\n}\n\nvar log = defaultLog;\n\nfunction Crawler(options) {\n  var self = this;\n  options = options || {};\n\n  if (['onDrain', 'cache'].some(key => key in options)) {\n    throw new Error('Support for \"onDrain\", \"cache\" has been removed! For more details, see https://github.com/bda-research/node-crawler');\n  }\n\n  self.init(options);\n} // augment the prototype for node events using util.inherits\n\n\nutil.inherits(Crawler, EventEmitter);\n\nCrawler.prototype.init = function init(options) {\n  var self = this;\n  var defaultOptions = {\n    autoWindowClose: true,\n    forceUTF8: true,\n    gzip: true,\n    incomingEncoding: null,\n    jQuery: true,\n    maxConnections: 10,\n    method: 'GET',\n    priority: 5,\n    priorityRange: 10,\n    rateLimit: 0,\n    referer: false,\n    retries: 3,\n    retryTimeout: 10000,\n    timeout: 15000,\n    skipDuplicates: false,\n    rotateUA: false,\n    homogeneous: false\n  }; //return defaultOptions with overriden properties from options.\n\n  self.options = _.extend(defaultOptions, options); // you can use jquery or jQuery\n\n  self.options = checkJQueryNaming(self.options); // Don't make these options persist to individual queries\n\n  self.globalOnlyOptions = ['maxConnections', 'rateLimit', 'priorityRange', 'homogeneous', 'skipDuplicates', 'rotateUA'];\n  self.limiters = new Bottleneck.Cluster(self.options.maxConnections, self.options.rateLimit, self.options.priorityRange, self.options.priority, self.options.homogeneous);\n  level = self.options.debug ? 'debug' : 'info';\n  if (self.options.logger) log = self.options.logger.log.bind(self.options.logger);\n  self.log = log;\n  self.seen = new seenreq(self.options.seenreq);\n  self.seen.initialize().then(() => log('debug', 'seenreq is initialized.')).catch(e => log('error', e));\n  self.on('_release', function () {\n    log('debug', 'Queue size: %d', this.queueSize);\n    if (this.limiters.empty) return this.emit('drain');\n  });\n};\n\nCrawler.prototype.setLimiterProperty = function setLimiterProperty(limiter, property, value) {\n  var self = this;\n\n  switch (property) {\n    case 'rateLimit':\n      self.limiters.key(limiter).setRateLimit(value);\n      break;\n\n    default:\n      break;\n  }\n};\n\nCrawler.prototype._inject = function _inject(response, options, callback) {\n  var $;\n\n  if (options.jQuery === 'whacko') {\n    if (!whacko) {\n      throw new Error('Please install whacko by your own since `crawler` detected you specify explicitly');\n    }\n\n    $ = whacko.load(response.body);\n    callback(null, response, options, $);\n  } else if (options.jQuery === 'cheerio' || options.jQuery.name === 'cheerio' || options.jQuery === true) {\n    var defaultCheerioOptions = {\n      normalizeWhitespace: false,\n      xmlMode: false,\n      decodeEntities: true\n    };\n    var cheerioOptions = options.jQuery.options || defaultCheerioOptions;\n    $ = cheerio.load(response.body, cheerioOptions);\n    callback(null, response, options, $);\n  } else if (options.jQuery.jsdom) {\n    var jsdom = options.jQuery.jsdom;\n    var scriptLocation = path.resolve(__dirname, '../vendor/jquery-2.1.1.min.js'); //Use promises\n\n    readJqueryUrl(scriptLocation, function (err, jquery) {\n      try {\n        jsdom.env({\n          url: options.uri,\n          html: response.body,\n          src: [jquery],\n          done: function (errors, window) {\n            $ = window.jQuery;\n            callback(errors, response, options, $);\n\n            try {\n              window.close();\n              window = null;\n            } catch (err) {\n              log('error', err);\n            }\n          }\n        });\n      } catch (e) {\n        options.callback(e, {\n          options\n        }, options.release);\n      }\n    });\n  } // Jquery is set to false are not set\n  else {\n      callback(null, response, options);\n    }\n};\n\nCrawler.prototype.isIllegal = function isIllegal(options) {\n  return _.isNull(options) || _.isUndefined(options) || !_.isString(options) && !_.isPlainObject(options);\n};\n\nCrawler.prototype.direct = function direct(options) {\n  var self = this;\n\n  if (self.isIllegal(options) || !_.isPlainObject(options)) {\n    return log('warn', 'Illegal queue option: ', JSON.stringify(options));\n  }\n\n  if (!('callback' in options) || !_.isFunction(options.callback)) {\n    return log('warn', 'must specify callback function when using sending direct request with crawler');\n  }\n\n  options = checkJQueryNaming(options); // direct request does not follow the global preRequest\n\n  options.preRequest = options.preRequest || null;\n\n  _.defaults(options, self.options); // direct request is not allowed to retry\n\n\n  options.retries = 0; // direct request does not emit event:'request' by default\n\n  options.skipEventRequest = _.isBoolean(options.skipEventRequest) ? options.skipEventRequest : true;\n  self.globalOnlyOptions.forEach(globalOnlyOption => delete options[globalOnlyOption]);\n\n  self._buildHttpRequest(options);\n};\n\nCrawler.prototype.queue = function queue(options) {\n  var self = this; // Did you get a single object or string? Make it compatible.\n\n  options = _.isArray(options) ? options : [options];\n  options = _.flattenDeep(options);\n\n  for (var i = 0; i < options.length; ++i) {\n    if (self.isIllegal(options[i])) {\n      log('warn', 'Illegal queue option: ', JSON.stringify(options[i]));\n      continue;\n    }\n\n    self._pushToQueue(_.isString(options[i]) ? {\n      uri: options[i]\n    } : options[i]);\n  }\n};\n\nCrawler.prototype._pushToQueue = function _pushToQueue(options) {\n  var self = this; // you can use jquery or jQuery\n\n  options = checkJQueryNaming(options);\n\n  _.defaults(options, self.options);\n\n  options.headers = _.assign({}, self.options.headers, options.headers); // Remove all the global options from our options\n  // TODO we are doing this for every _pushToQueue, find a way to avoid this\n\n  self.globalOnlyOptions.forEach(globalOnlyOption => delete options[globalOnlyOption]); // If duplicate skipping is enabled, avoid queueing entirely for URLs we already crawled\n\n  if (!self.options.skipDuplicates) {\n    self._schedule(options);\n\n    return;\n  }\n\n  self.seen.exists(options, options.seenreq).then(rst => {\n    if (!rst) {\n      self._schedule(options);\n    }\n  }).catch(e => log('error', e));\n};\n\nCrawler.prototype._schedule = function _scheduler(options) {\n  var self = this;\n  self.emit('schedule', options);\n  self.limiters.key(options.limiter || 'default').submit(options.priority, function (done, limiter) {\n    options.release = function () {\n      done();\n      self.emit('_release');\n    };\n\n    if (!options.callback) options.callback = options.release;\n\n    if (limiter) {\n      self.emit('limiterChange', options, limiter);\n    }\n\n    if (options.html) {\n      self._onContent(null, options, {\n        body: options.html,\n        headers: {\n          'content-type': 'text/html'\n        }\n      });\n    } else if (typeof options.uri === 'function') {\n      options.uri(function (uri) {\n        options.uri = uri;\n\n        self._buildHttpRequest(options);\n      });\n    } else {\n      self._buildHttpRequest(options);\n    }\n  });\n};\n\nCrawler.prototype._buildHttpRequest = function _buildHTTPRequest(options) {\n  var self = this;\n  log('debug', options.method + ' ' + options.uri);\n  if (options.proxy) log('debug', 'Use proxy: %s', options.proxy); // Cloning keeps the opts parameter clean:\n  // - some versions of \"request\" apply the second parameter as a\n  // property called \"callback\" to the first parameter\n  // - keeps the query object fresh in case of a retry\n\n  var ropts = _.assign({}, options);\n\n  if (!ropts.headers) {\n    ropts.headers = {};\n  }\n\n  if (ropts.forceUTF8) {\n    ropts.encoding = null;\n  } // specifying json in request will have request sets body to JSON representation of value and\n  // adds Content-type: application/json header. Additionally, parses the response body as JSON\n  // so the response will be JSON object, no need to deal with encoding\n\n\n  if (ropts.json) {\n    options.encoding = null;\n  }\n\n  if (ropts.userAgent) {\n    if (self.options.rotateUA && _.isArray(ropts.userAgent)) {\n      ropts.headers['User-Agent'] = ropts.userAgent[0]; // If \"rotateUA\" is true, rotate User-Agent\n\n      options.userAgent.push(options.userAgent.shift());\n    } else {\n      ropts.headers['User-Agent'] = ropts.userAgent;\n    }\n  }\n\n  if (ropts.referer) {\n    ropts.headers.Referer = ropts.referer;\n  }\n\n  if (ropts.proxies && ropts.proxies.length) {\n    ropts.proxy = ropts.proxies[0];\n  }\n\n  var doRequest = function (err) {\n    if (err) {\n      err.message = 'Error in preRequest' + (err.message ? ', ' + err.message : err.message);\n\n      switch (err.op) {\n        case 'retry':\n          log('debug', err.message + ', retry ' + options.uri);\n\n          self._onContent(err, options);\n\n          break;\n\n        case 'fail':\n          log('debug', err.message + ', fail ' + options.uri);\n          options.callback(err, {\n            options: options\n          }, options.release);\n          break;\n\n        case 'abort':\n          log('debug', err.message + ', abort ' + options.uri);\n          options.release();\n          break;\n\n        case 'queue':\n          log('debug', err.message + ', queue ' + options.uri);\n          self.queue(options);\n          options.release();\n          break;\n\n        default:\n          log('debug', err.message + ', retry ' + options.uri);\n\n          self._onContent(err, options);\n\n          break;\n      }\n\n      return;\n    }\n\n    if (ropts.skipEventRequest !== true) {\n      self.emit('request', ropts);\n    }\n\n    var requestArgs = ['uri', 'url', 'qs', 'method', 'headers', 'body', 'form', 'formData', 'json', 'multipart', 'followRedirect', 'followAllRedirects', 'maxRedirects', 'encoding', 'pool', 'timeout', 'proxy', 'auth', 'oauth', 'strictSSL', 'jar', 'aws', 'gzip', 'time', 'tunnel', 'proxyHeaderWhiteList', 'proxyHeaderExclusiveList', 'localAddress', 'forever', 'agent'];\n    request(_.pick.apply(self, [ropts].concat(requestArgs)), function (error, response) {\n      if (error) {\n        return self._onContent(error, options);\n      }\n\n      self._onContent(error, options, response);\n    });\n  };\n\n  if (options.preRequest && _.isFunction(options.preRequest)) {\n    options.preRequest(ropts, doRequest);\n  } else {\n    doRequest();\n  }\n};\n\nCrawler.prototype._onContent = function _onContent(error, options, response) {\n  var self = this;\n\n  if (error) {\n    log('error', 'Error ' + error + ' when fetching ' + (options.uri || options.url) + (options.retries ? ' (' + options.retries + ' retries left)' : ''));\n\n    if (options.retries) {\n      self.options.skipDuplicates = false;\n      setTimeout(function () {\n        options.retries--;\n        self.queue(options);\n        options.release();\n      }, options.retryTimeout);\n    } else {\n      options.callback(error, {\n        options: options\n      }, options.release);\n    }\n\n    return;\n  }\n\n  if (!response.body) {\n    response.body = '';\n  }\n\n  log('debug', 'Got ' + (options.uri || 'html') + ' (' + response.body.length + ' bytes)...');\n\n  try {\n    self._doEncoding(options, response);\n  } catch (e) {\n    log('error', e);\n    return options.callback(e, {\n      options: options\n    }, options.release);\n  }\n\n  response.options = options;\n\n  if (options.method === 'HEAD' || !options.jQuery) {\n    return options.callback(null, response, options.release);\n  }\n\n  var injectableTypes = ['html', 'xhtml', 'text/xml', 'application/xml', '+xml'];\n\n  if (!options.html && !typeis(contentType(response), injectableTypes)) {\n    log('warn', 'response body is not HTML, skip injecting. Set jQuery to false to suppress this message');\n    return options.callback(null, response, options.release);\n  }\n\n  log('debug', 'Injecting');\n\n  self._inject(response, options, self._injected.bind(self));\n};\n\nCrawler.prototype._injected = function (errors, response, options, $) {\n  log('debug', 'Injected');\n  response.$ = $;\n  options.callback(errors, response, options.release);\n};\n\nCrawler.prototype._doEncoding = function (options, response) {\n  var self = this;\n\n  if (options.encoding === null) {\n    return;\n  }\n\n  if (options.forceUTF8) {\n    var charset = options.incomingEncoding || self._parseCharset(response);\n\n    response.charset = charset;\n    log('debug', 'Charset ' + charset);\n\n    if (charset !== 'utf-8' && charset !== 'ascii') {\n      // convert response.body into 'utf-8' encoded buffer\n      response.body = iconvLite.decode(response.body, charset);\n    }\n  }\n\n  response.body = response.body.toString();\n};\n\nCrawler.prototype._parseCharset = function (res) {\n  //Browsers treat gb2312 as gbk, but iconv-lite not.\n  //Replace gb2312 with gbk, in order to parse the pages which say gb2312 but actually are gbk.\n  function getCharset(str) {\n    var charset = (str && str.match(/charset=['\"]?([\\w.-]+)/i) || [0, null])[1];\n    return charset && charset.replace(/:\\d{4}$|[^0-9a-z]/g, '') == 'gb2312' ? 'gbk' : charset;\n  }\n\n  function charsetParser(header, binary, default_charset = null) {\n    return getCharset(header) || getCharset(binary) || default_charset;\n  }\n\n  var charset = charsetParser(contentType(res));\n  if (charset) return charset;\n\n  if (!typeis(contentType(res), ['html'])) {\n    log('debug', 'Charset not detected in response headers, please specify using `incomingEncoding`, use `utf-8` by default');\n    return 'utf-8';\n  }\n\n  var body = res.body instanceof Buffer ? res.body.toString() : res.body;\n  charset = charsetParser(contentType(res), body, 'utf-8');\n  return charset;\n};\n\nObject.defineProperty(Crawler.prototype, 'queueSize', {\n  get: function () {\n    return this.limiters.unfinishedClients;\n  }\n});\nmodule.exports = Crawler;","map":{"version":3,"sources":["/Users/marshoward/Development/code/river/frontend/app/node_modules/crawler/lib/crawler.js"],"names":["path","require","util","EventEmitter","request","_","cheerio","fs","Bottleneck","seenreq","iconvLite","typeis","is","whacko","level","levels","e","code","defaultLog","indexOf","arguments","console","log","Date","toJSON","format","apply","Array","prototype","slice","call","checkJQueryNaming","options","jQuery","jquery","readJqueryUrl","url","callback","match","readFile","replace","err","jq","contentType","res","get","split","filter","item","trim","length","join","field","headers","toLowerCase","Crawler","self","some","key","Error","init","inherits","defaultOptions","autoWindowClose","forceUTF8","gzip","incomingEncoding","maxConnections","method","priority","priorityRange","rateLimit","referer","retries","retryTimeout","timeout","skipDuplicates","rotateUA","homogeneous","extend","globalOnlyOptions","limiters","Cluster","debug","logger","bind","seen","initialize","then","catch","on","queueSize","empty","emit","setLimiterProperty","limiter","property","value","setRateLimit","_inject","response","$","load","body","name","defaultCheerioOptions","normalizeWhitespace","xmlMode","decodeEntities","cheerioOptions","jsdom","scriptLocation","resolve","__dirname","env","uri","html","src","done","errors","window","close","release","isIllegal","isNull","isUndefined","isString","isPlainObject","direct","JSON","stringify","isFunction","preRequest","defaults","skipEventRequest","isBoolean","forEach","globalOnlyOption","_buildHttpRequest","queue","isArray","flattenDeep","i","_pushToQueue","assign","_schedule","exists","rst","_scheduler","submit","_onContent","_buildHTTPRequest","proxy","ropts","encoding","json","userAgent","push","shift","Referer","proxies","doRequest","message","op","requestArgs","pick","concat","error","setTimeout","_doEncoding","injectableTypes","_injected","charset","_parseCharset","decode","toString","getCharset","str","charsetParser","header","binary","default_charset","Buffer","Object","defineProperty","unfinishedClients","module","exports"],"mappings":"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","sourcesContent":["\n'use strict';\n\nvar path = require('path')\n\t, util = require('util')\n\t, EventEmitter = require('events').EventEmitter\n\t, request = require('request')\n\t, _ = require('lodash')\n\t, cheerio = require('cheerio')\n\t, fs = require('fs')\n\t, Bottleneck = require('bottleneckp')\n\t, seenreq = require('seenreq')\n\t, iconvLite = require('iconv-lite')\n\t, typeis = require('type-is').is;\n\nvar whacko=null, level, levels = ['silly','debug','verbose','info','warn','error','critical'];\ntry{\n\twhacko = require('whacko');\n}catch(e){\n\te.code;\n}\n\nfunction defaultLog(){    //2016-11-24T12:22:55.639Z - debug:\n\tif( levels.indexOf(arguments[0]) >= levels.indexOf(level) )\n\t\tconsole.log(new Date().toJSON()+' - '+ arguments[0] +': CRAWLER %s', util.format.apply(util, Array.prototype.slice.call(arguments, 1)));\n}\n\nfunction checkJQueryNaming (options) {\n\tif ('jquery' in options) {\n\t\toptions.jQuery = options.jquery;\n\t\tdelete options.jquery;\n\t}\n\treturn options;\n}\n\nfunction readJqueryUrl (url, callback) {\n\tif (url.match(/^(file:\\/\\/|\\w+:|\\/)/)) {\n\t\tfs.readFile(url.replace(/^file:\\/\\//,''),'utf-8', function(err,jq) {\n\t\t\tcallback(err, jq);\n\t\t});\n\t} else {\n\t\tcallback(null, url);\n\t}\n}\n\nfunction contentType(res){\n\treturn get(res,'content-type').split(';').filter(item => item.trim().length !== 0).join(';');\n}\n\nfunction get(res,field){\n\treturn res.headers[field.toLowerCase()] || '';\n}\n\nvar log = defaultLog;\n\nfunction Crawler (options) {\n\tvar self = this;\n\n\toptions = options||{};\n\tif(['onDrain','cache'].some(key => key in options)){\n\t\tthrow new Error('Support for \"onDrain\", \"cache\" has been removed! For more details, see https://github.com/bda-research/node-crawler');\n\t}\n\n\tself.init(options);\n}\n// augment the prototype for node events using util.inherits\nutil.inherits(Crawler, EventEmitter);\n\nCrawler.prototype.init = function init (options) {\n\tvar self = this;\n\n\tvar defaultOptions = {\n\t\tautoWindowClose:        true,\n\t\tforceUTF8:              true,\n\t\tgzip:                   true,\n\t\tincomingEncoding:       null,\n\t\tjQuery:                 true,\n\t\tmaxConnections:         10,\n\t\tmethod:                 'GET',\n\t\tpriority:               5,\n\t\tpriorityRange:          10,\n\t\trateLimit:             0,\n\t\treferer:                false,\n\t\tretries:                3,\n\t\tretryTimeout:           10000,\n\t\ttimeout:                15000,\n\t\tskipDuplicates:         false,\n\t\trotateUA:               false,\n\t\thomogeneous:            false\n\t};\n\n\t//return defaultOptions with overriden properties from options.\n\tself.options = _.extend(defaultOptions, options);\n\n\t// you can use jquery or jQuery\n\tself.options = checkJQueryNaming(self.options);\n\n\t// Don't make these options persist to individual queries\n\tself.globalOnlyOptions = ['maxConnections', 'rateLimit', 'priorityRange', 'homogeneous', 'skipDuplicates', 'rotateUA'];\n\n\tself.limiters = new Bottleneck.Cluster(self.options.maxConnections,self.options.rateLimit,self.options.priorityRange, self.options.priority, self.options.homogeneous);\n\n\tlevel = self.options.debug ? 'debug' : 'info';\n\n\tif(self.options.logger)\n\t\tlog = self.options.logger.log.bind(self.options.logger);\n\n\tself.log = log;\n\n\tself.seen = new seenreq(self.options.seenreq);\n\tself.seen.initialize().then(()=> log('debug', 'seenreq is initialized.')).catch(e => log('error', e));\n\t\n\tself.on('_release', function(){\n\t\tlog('debug','Queue size: %d',this.queueSize);\n\n\t\tif(this.limiters.empty)\n\t\t\treturn this.emit('drain');\n\t});\n};\n\nCrawler.prototype.setLimiterProperty = function setLimiterProperty (limiter, property, value) {\n\tvar self = this;\n\n\tswitch(property) {\n\tcase 'rateLimit': self.limiters.key(limiter).setRateLimit(value);break;\n\tdefault: break;\n\t}\n};\n\nCrawler.prototype._inject = function _inject (response, options, callback) {\n\tvar $;\n\n\tif (options.jQuery === 'whacko') {\n\t\tif(!whacko){\n\t\t\tthrow new Error('Please install whacko by your own since `crawler` detected you specify explicitly');\n\t\t}\n\n\t\t$ = whacko.load(response.body);\n\t\tcallback(null, response, options, $);\n\t}else if (options.jQuery === 'cheerio' || options.jQuery.name === 'cheerio' || options.jQuery === true) {\n\t\tvar defaultCheerioOptions = {\n\t\t\tnormalizeWhitespace: false,\n\t\t\txmlMode: false,\n\t\t\tdecodeEntities: true\n\t\t};\n\t\tvar cheerioOptions = options.jQuery.options || defaultCheerioOptions;\n\t\t$ = cheerio.load(response.body, cheerioOptions);\n\n\t\tcallback(null, response, options, $);\n\t}else if (options.jQuery.jsdom) {\n\t\tvar jsdom = options.jQuery.jsdom;\n\t\tvar scriptLocation = path.resolve(__dirname, '../vendor/jquery-2.1.1.min.js');\n\n\t\t//Use promises\n\t\treadJqueryUrl(scriptLocation, function(err, jquery) {\n\t\t\ttry {\n\t\t\t\tjsdom.env({\n\t\t\t\t\turl: options.uri,\n\t\t\t\t\thtml: response.body,\n\t\t\t\t\tsrc: [jquery],\n\t\t\t\t\tdone: function (errors, window) {\n\t\t\t\t\t\t$ = window.jQuery;\n\t\t\t\t\t\tcallback(errors, response, options, $);\n\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\twindow.close();\n\t\t\t\t\t\t\twindow = null;\n\t\t\t\t\t\t} catch (err) {\n\t\t\t\t\t\t\tlog('error',err);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t} catch (e) {\n\t\t\t\toptions.callback(e,{options}, options.release);\n\t\t\t}\n\t\t});\n\t}\n\t// Jquery is set to false are not set\n\telse {\n\t\tcallback(null, response, options);\n\t}\n};\n\nCrawler.prototype.isIllegal = function isIllegal (options) {\n\treturn (_.isNull(options) || _.isUndefined(options) || (!_.isString(options) && !_.isPlainObject(options)));\n};\n\nCrawler.prototype.direct = function direct (options) {\n\tvar self = this;\n\n\tif(self.isIllegal(options) || !_.isPlainObject(options)) {\n\t\treturn log('warn','Illegal queue option: ', JSON.stringify(options));\n\t}\n\n\tif(!('callback' in options) || !_.isFunction(options.callback)) {\n\t\treturn log('warn','must specify callback function when using sending direct request with crawler');\n\t}\n\n\toptions = checkJQueryNaming(options);\n\n\t// direct request does not follow the global preRequest\n\toptions.preRequest = options.preRequest || null;\n\n\t_.defaults(options, self.options);\n\n\t// direct request is not allowed to retry\n\toptions.retries = 0;\n\n\t// direct request does not emit event:'request' by default\n\toptions.skipEventRequest = _.isBoolean(options.skipEventRequest) ? options.skipEventRequest : true;\n\n\tself.globalOnlyOptions.forEach(globalOnlyOption => delete options[globalOnlyOption]);\n\n\tself._buildHttpRequest(options);\n};\n\nCrawler.prototype.queue = function queue (options) {\n\tvar self = this;\n\n\t// Did you get a single object or string? Make it compatible.\n\toptions = _.isArray(options) ? options : [options];\n\n\toptions = _.flattenDeep(options);\n\n\tfor(var i = 0; i < options.length; ++i) {\n\t\tif(self.isIllegal(options[i])) {\n\t\t\tlog('warn','Illegal queue option: ', JSON.stringify(options[i]));\n\t\t\tcontinue;\n\t\t}\n\t\tself._pushToQueue(\n\t\t\t_.isString(options[i]) ? {uri: options[i]} : options[i]\n\t\t);\n\t}\n};\n\nCrawler.prototype._pushToQueue = function _pushToQueue (options) {\n\tvar self = this;\n\n\t// you can use jquery or jQuery\n\toptions = checkJQueryNaming(options);\n\n\t_.defaults(options, self.options);\n\toptions.headers = _.assign({}, self.options.headers, options.headers);\n\n\t// Remove all the global options from our options\n\t// TODO we are doing this for every _pushToQueue, find a way to avoid this\n\tself.globalOnlyOptions.forEach(globalOnlyOption => delete options[globalOnlyOption]);\n\n\t// If duplicate skipping is enabled, avoid queueing entirely for URLs we already crawled\n\tif (!self.options.skipDuplicates){\n\t\tself._schedule(options);\n\t\treturn;\n\t}\n\n\tself.seen.exists(options, options.seenreq).then(rst => {\n\t\tif(!rst){\n\t\t\tself._schedule(options);\n\t\t}\n\t}).catch(e => log('error', e));\n};\n\nCrawler.prototype._schedule = function _scheduler(options){\n\tvar self = this;\n\tself.emit('schedule',options);\n\n\tself.limiters.key(options.limiter||'default').submit(options.priority,function(done, limiter){\n\t\toptions.release = function(){ done();self.emit('_release'); };\n\t\tif(!options.callback)\n\t\t\toptions.callback = options.release;\n\n\t\tif (limiter) {\n\t\t\tself.emit('limiterChange', options, limiter);\n\t\t}\n\n\t\tif (options.html) {\n\t\t\tself._onContent(null, options, {body:options.html,headers:{'content-type':'text/html'}});\n\t\t} else if (typeof options.uri === 'function') {\n\t\t\toptions.uri(function(uri) {\n\t\t\t\toptions.uri = uri;\n\t\t\t\tself._buildHttpRequest(options);\n\t\t\t});\n\t\t} else {\n\t\t\tself._buildHttpRequest(options);\n\t\t}\n\t});\n};\n\nCrawler.prototype._buildHttpRequest = function _buildHTTPRequest (options) {\n\tvar self = this;\n\n\tlog('debug',options.method+' '+options.uri);\n\tif(options.proxy)\n\t\tlog('debug','Use proxy: %s', options.proxy);\n\n\t// Cloning keeps the opts parameter clean:\n\t// - some versions of \"request\" apply the second parameter as a\n\t// property called \"callback\" to the first parameter\n\t// - keeps the query object fresh in case of a retry\n\n\tvar ropts = _.assign({},options);\n\n\tif (!ropts.headers) { ropts.headers={}; }\n\tif (ropts.forceUTF8) {ropts.encoding=null;}\n\t// specifying json in request will have request sets body to JSON representation of value and\n\t// adds Content-type: application/json header. Additionally, parses the response body as JSON\n\t// so the response will be JSON object, no need to deal with encoding\n\tif (ropts.json) {options.encoding=null;}\n\tif (ropts.userAgent) {\n\t\tif(self.options.rotateUA && _.isArray(ropts.userAgent)){\n\t\t\tropts.headers['User-Agent'] = ropts.userAgent[0];\n\t\t\t// If \"rotateUA\" is true, rotate User-Agent\n\t\t\toptions.userAgent.push(options.userAgent.shift());\n\t\t}else{\n\t\t\tropts.headers['User-Agent'] = ropts.userAgent;\n\t\t}\n\t}\n\n\tif (ropts.referer) {\n\t\tropts.headers.Referer = ropts.referer;\n\t}\n\n\tif (ropts.proxies && ropts.proxies.length) {\n\t\tropts.proxy = ropts.proxies[0];\n\t}\n\n\tvar doRequest = function(err) {\n\t\tif(err) {\n\t\t\terr.message = 'Error in preRequest' + (err.message ? ', '+err.message : err.message);\n\t\t\tswitch(err.op) {\n\t\t\tcase 'retry': log('debug', err.message + ', retry ' + options.uri);self._onContent(err,options);break;\n\t\t\tcase 'fail': log('debug', err.message + ', fail ' + options.uri);options.callback(err,{options:options},options.release);break;\n\t\t\tcase 'abort': log('debug', err.message + ', abort ' + options.uri);options.release();break;\n\t\t\tcase 'queue': log('debug', err.message + ', queue ' + options.uri);self.queue(options);options.release();break;\n\t\t\tdefault: log('debug', err.message + ', retry ' + options.uri);self._onContent(err,options);break;\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\n\t\tif(ropts.skipEventRequest !== true) {\n\t\t\tself.emit('request',ropts);\n\t\t}\n\n\t\tvar requestArgs = ['uri','url','qs','method','headers','body','form','formData','json','multipart','followRedirect','followAllRedirects', 'maxRedirects','encoding','pool','timeout','proxy','auth','oauth','strictSSL','jar','aws','gzip','time','tunnel','proxyHeaderWhiteList','proxyHeaderExclusiveList','localAddress','forever', 'agent'];\n\n\t\trequest(_.pick.apply(self,[ropts].concat(requestArgs)), function(error,response) {\n\t\t\tif (error) {\n\t\t\t\treturn self._onContent(error, options);\n\t\t\t}\n\n\t\t\tself._onContent(error,options,response);\n\t\t});\n\t};\n\n\tif (options.preRequest && _.isFunction(options.preRequest)) {\n\t\toptions.preRequest(ropts, doRequest);\n\t} else {\n\t\tdoRequest();\n\t}\n};\n\nCrawler.prototype._onContent = function _onContent (error, options, response) {\n\tvar self = this;\n\n\tif (error) {\n\t\tlog('error','Error '+error+' when fetching '+ (options.uri||options.url)+(options.retries ? ' ('+options.retries+' retries left)' : ''));\n\n\t\tif (options.retries) {\n\t\t\tself.options.skipDuplicates = false;\n\t\t\tsetTimeout(function() {\n\t\t\t\toptions.retries--;\n\t\t\t\tself.queue(options);\n\t\t\t\toptions.release();\n\t\t\t},options.retryTimeout);\n\t\t} else{\n\t\t\toptions.callback(error,{options:options},options.release);\n\t\t}\n\n\t\treturn;\n\t}\n\n\tif (!response.body) { response.body=''; }\n\n\tlog('debug','Got '+(options.uri||'html')+' ('+response.body.length+' bytes)...');\n\n\ttry{\n\t\tself._doEncoding(options,response);\n\t}catch(e){\n\t\tlog('error',e);\n\t\treturn options.callback(e,{options:options},options.release);\n\t}\n\n\tresponse.options = options;\n\n\tif(options.method === 'HEAD' || !options.jQuery){\n\t\treturn options.callback(null,response,options.release);\n\t}\n\n\tvar injectableTypes = ['html','xhtml','text/xml', 'application/xml', '+xml'];\n\tif (!options.html && !typeis(contentType(response), injectableTypes)){\n\t\tlog('warn','response body is not HTML, skip injecting. Set jQuery to false to suppress this message');\n\t\treturn options.callback(null,response,options.release);\n\t}\n\n\tlog('debug','Injecting');\n\n\tself._inject(response, options, self._injected.bind(self));\n};\n\nCrawler.prototype._injected = function(errors, response, options, $){\n\tlog('debug','Injected');\n\n\tresponse.$ = $;\n\toptions.callback(errors, response, options.release);\n};\n\nCrawler.prototype._doEncoding = function(options,response){\n\tvar self = this;\n\n\tif(options.encoding === null){\n\t\treturn;\n\t}\n\n\tif (options.forceUTF8) {\n\t\tvar charset = options.incomingEncoding || self._parseCharset(response);\n\t\tresponse.charset = charset;\n\t\tlog('debug','Charset ' + charset);\n\n\t\tif (charset !== 'utf-8' && charset !== 'ascii') {// convert response.body into 'utf-8' encoded buffer\n\t\t\tresponse.body = iconvLite.decode(response.body, charset);\n\t\t}\n\t}\n\n\tresponse.body = response.body.toString();\n};\n\nCrawler.prototype._parseCharset = function(res){\n\t//Browsers treat gb2312 as gbk, but iconv-lite not.\n\t//Replace gb2312 with gbk, in order to parse the pages which say gb2312 but actually are gbk.\n\tfunction getCharset(str){\n\t\tvar charset = (str && str.match(/charset=['\"]?([\\w.-]+)/i) || [0, null])[1];\n\t\treturn charset && charset.replace(/:\\d{4}$|[^0-9a-z]/g, '') == 'gb2312' ? 'gbk' : charset;\n\t}\n\tfunction charsetParser(header, binary, default_charset = null) {\n\t\treturn getCharset(header) || getCharset(binary) || default_charset;\n\t}\n\n\tvar charset = charsetParser(contentType(res));\n\tif(charset)\n\t\treturn charset;\n\n\tif(!typeis(contentType(res), ['html'])){\n\t\tlog('debug','Charset not detected in response headers, please specify using `incomingEncoding`, use `utf-8` by default');\n\t\treturn 'utf-8';\n\t}\n\n\tvar body = res.body instanceof Buffer ? res.body.toString() : res.body;\n\tcharset = charsetParser(contentType(res),body,'utf-8');\n\n\treturn charset;\n};\n\nObject.defineProperty(Crawler.prototype,'queueSize',{\n\tget:function(){\n\t\treturn this.limiters.unfinishedClients;\n\t}\n});\n\nmodule.exports = Crawler;\n"]},"metadata":{},"sourceType":"script"}